<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.9">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="L1l RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="L1l Atom Feed">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css" integrity="sha384-Um5gpz1odJg5Z4HAmzPtgZKdTBHZdw8S29IecapCSB31ligYPhHQZMIlWLYQGVoc" crossorigin="anonymous"><title data-react-helmet="true">操作系统 OS Lab3 实验报告 | L1l</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://mondaycha.github.io/BUAA/操作系统实验/操作系统-OS-Lab3-实验报告"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="操作系统 OS Lab3 实验报告 | L1l"><meta data-react-helmet="true" name="description" content="一、实验思考题"><meta data-react-helmet="true" property="og:description" content="一、实验思考题"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://mondaycha.github.io/BUAA/操作系统实验/操作系统-OS-Lab3-实验报告"><link data-react-helmet="true" rel="alternate" href="https://mondaycha.github.io/BUAA/操作系统实验/操作系统-OS-Lab3-实验报告" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://mondaycha.github.io/BUAA/操作系统实验/操作系统-OS-Lab3-实验报告" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.67d8d4ca.css">
<link rel="preload" href="/assets/js/runtime~main.f755d14c.js" as="script">
<link rel="preload" href="/assets/js/main.2253602e.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="MondayCha" class="themedImage_1VuW themedImage--light_3UqQ"><img src="/img/logo.svg" alt="MondayCha" class="themedImage_1VuW themedImage--dark_hz6m"></div><b class="navbar__title">L1l</b></a><a class="navbar__item navbar__link navbar__link--active" href="/">随笔</a><a class="navbar__item navbar__link" href="/blog">日常</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/MondayCha" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_71bT toggle_3Zt9 toggleDisabled_3cF-"><div class="toggleTrack_32Fl" role="button" tabindex="-1"><div class="toggleTrackCheck_3lV7"><span class="toggleIcon_O4iE">🌜</span></div><div class="toggleTrackX_S2yS"><span class="toggleIcon_O4iE">🌞</span></div><div class="toggleTrackThumb_xI_Z"></div></div><input type="checkbox" class="toggleScreenReader_28Tw" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_35hR" type="button"></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/">主页</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">算法学习</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">软件开发</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">本科课程</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">操作系统实验</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/BUAA/操作系统实验/操作系统-OS-Lab0-实验报告">操作系统 OS Lab0 实验报告</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/BUAA/操作系统实验/操作系统-OS-Lab0">操作系统 OS Lab0</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/BUAA/操作系统实验/操作系统-OS-Lab1-实验报告">操作系统 OS Lab1 实验报告</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/BUAA/操作系统实验/操作系统-OS-Lab2-学习笔记-「Part-1」">操作系统 OS Lab2 学习笔记 「Part 1」</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/BUAA/操作系统实验/操作系统-OS-Lab2-学习笔记-「Part-2」">操作系统 OS Lab2 学习笔记 「Part 2」</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/BUAA/操作系统实验/操作系统-OS-Lab2-实验报告">操作系统 OS Lab2 实验报告</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/BUAA/操作系统实验/操作系统-OS-Lab3-学习笔记">操作系统 OS Lab3 学习笔记</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/BUAA/操作系统实验/操作系统-OS-Lab3-实验报告">操作系统 OS Lab3 实验报告</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/BUAA/操作系统实验/操作系统-OS-Lab4-extra-学习笔记">操作系统 OS Lab4-extra 学习笔记</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/BUAA/操作系统实验/操作系统-OS-Lab4-学习笔记">操作系统 OS Lab4 学习笔记</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/BUAA/操作系统实验/操作系统-OS-Lab4-实验报告">操作系统 OS Lab4 实验报告</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/BUAA/操作系统实验/操作系统-OS-Lab5-实验笔记">操作系统 OS Lab5 实验笔记</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/BUAA/操作系统实验/操作系统-OS-第五次作业">操作系统 OS 第五次作业</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">航空航天概论</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">软件工程</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">面向对象设计与构造</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">马克思主义原理</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">ACGN</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>OS Lab3 实验报告</h1></header><h2 class="anchor anchorWithStickyNavbar_31ik" id="一实验思考题">一、实验思考题<a aria-hidden="true" class="hash-link" href="#一实验思考题" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_31ik" id="thinking-31">Thinking 3.1<a aria-hidden="true" class="hash-link" href="#thinking-31" title="Direct link to heading">​</a></h3><p>为什么我们在构造空闲进程链表时必须使用特定的插入的顺序？(顺序或者逆序)</p><p>答：</p><p>因为注释要求“确保在插入之后，env在列表中的顺序应该与envs数组中的相同”，这样就会使第一次调用env_alloc()时返回envs<!-- -->[0]<!-- -->。</p><h3 class="anchor anchorWithStickyNavbar_31ik" id="thinking-32">Thinking 3.2<a aria-hidden="true" class="hash-link" href="#thinking-32" title="Direct link to heading">​</a></h3><p>思考env.c/mkenvid 函数和envid2env 函数:</p><ul><li>请你谈谈对mkenvid 函数中生成id 的运算的理解，为什么这么做？</li><li>为什么envid2env 中需要判断e-&gt;env_id != envid 的情况？如果没有这步判断会发生什么情况？</li></ul><p>答：</p><p>(1) 生成ID的式子为<code>return (++next_env_id &lt;&lt; (1 + LOG2NENV)) | idx;</code>，其中1-10位是对应进程在envs数组中的下标；12位起是由mkenvid被调用次数形成的唯一ID，这样做可以确保生成新进程id都是唯一的。</p><p>(2) 因为envid2env 中e是通过宏<code>ENVX()</code>获取envid的低10位，从而获得进程在envs数组中的下标，而不同进程可能在envs数组中有相同的下标，如果没有这步判断可能导致返回错误进程，因此需要用e-&gt;env_id != envid验证从envs数组中获取的进程是否为所需进程。</p><h3 class="anchor anchorWithStickyNavbar_31ik" id="thinking-33">Thinking 3.3<a aria-hidden="true" class="hash-link" href="#thinking-33" title="Direct link to heading">​</a></h3><p>结合include/mmu.h 中的地址空间布局，思考env_setup_vm 函数：</p><ul><li>我们在初始化新进程的地址空间时为什么不把整个地址空间的pgdir 都清零，而是复制内核的boot_pgdir作为一部分模板？(提示:mips 虚拟空间布局)</li><li>UTOP 和ULIM 的含义分别是什么，在UTOP 到ULIM 的区域与其他用户区相比有什么最大的区别？</li><li>在env_setup_vm 函数的最后，我们为什么要让pgdir<!-- -->[PDX(UVPT)]<!-- -->=env_cr3?(提示: 结合系统自映射机制)</li><li>谈谈自己对进程中物理地址和虚拟地址的理解</li></ul><p>答：</p><p>(1) 根据mmu.h里面的布局，我们的操作系统是2G/2G 模式，在本实验中，UTOP以上的虚拟地址空间到物理地址的映射关系都是一样的。因此复制内核的boot_pgdir中UTOP以上的内容到pgdir中，在进入内核态时不需要切换CR3寄存器。</p><p>(2) ULIM划分了用户空间与内核空间，UTOP属于用户空间，但UTOP至ULIM的区域与其他用户区相比，用户只能读不能写，其由三个4M大小的空间组成，分别存放进程envs数组、pages数组、进程页表。</p><p>(3) UVPT(0x7fc00000) 到 ULIM(0x80000000) 之间的空间为4MB ，这一区域就是进程的页表的位置，而PDX(UVPT)就是页目录自映射所对应的页目录在页表中的位置，因此要让pgdir<!-- -->[PDX(UVPT)]<!-- -->=env_cr3。</p><p>(4) 不同进程有各自的虚拟空间，访问相同虚拟地址时得到的结果可能是不同的；对于不同的进程而言，虚拟地址ULIM 以上的地方虚拟地址到物理地址的映射关系都是一样的，方便内核对进程进行管理。</p><h3 class="anchor anchorWithStickyNavbar_31ik" id="thinking-34">Thinking 3.4<a aria-hidden="true" class="hash-link" href="#thinking-34" title="Direct link to heading">​</a></h3><p>思考user_data 这个参数的作用。没有这个参数可不可以？为什么？（如果你能说明哪些应用场景中可能会应用这种设计就更好了。可以举一个实际的库中的例子）</p><p>答：</p><p>不可以。在我们的实验中，与user_data有关的函数是load_icode、load_elf、load_icode_mapper，其中的user_data就是进程e的指针，是不可或缺的。</p><p>应用场景：load_icode_mapper是一个回调函数，回调函数就是允许用户把需要调用的函数的指针作为参数传递给一个函数，以便该函数在处理相似事件的时候可以灵活的使用不同的方法。C语言标准库<code>&lt;stdlib.h&gt;</code>中的排序qsort就用到了这种设计：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly c"><pre tabindex="0" class="prism-code language-c codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">qsort</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">base</span><span class="token punctuation" style="color:#393A34">,</span><span class="token class-name">size_t</span><span class="token plain"> num</span><span class="token punctuation" style="color:#393A34">,</span><span class="token class-name">size_t</span><span class="token plain"> width</span><span class="token punctuation" style="color:#393A34">,</span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__cdecl</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">compare</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">,</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>这之中的compare就是回调函数，两个形参是const void *型，有着很高的泛用性，与user_data的设计类似。</p><h3 class="anchor anchorWithStickyNavbar_31ik" id="thinking-35">Thinking 3.5<a aria-hidden="true" class="hash-link" href="#thinking-35" title="Direct link to heading">​</a></h3><p>结合load_icode_mapper 的参数以及二进制镜像的大小，考虑该函数可能会面临哪几种复制的情况？你是否都考虑到了？ （提示：1、页面大小是多少；2、回顾lab1中的ELF文件解析，什么时候需要自动填充.bss段）</p><p>答：</p><ol><li>若va不对齐，拷贝长度要选择BY2PG - offset和bin_size中的最小值，复制第一页。</li><li>i &lt; bin_size时，如果i &lt; bin_size - BY2PG，那么就以BY2PG步进，复制每一页；如果出现了BY2PG &gt; bin_size - i的情况，那么依然要分配一页的空间。</li><li>如果i仍然小于sgsize，需要继续申请页面并置0。</li></ol><p>.bss 段是全部要置零，也就包含在置零的空间中。</p><h3 class="anchor anchorWithStickyNavbar_31ik" id="thinking-36">Thinking 3.6<a aria-hidden="true" class="hash-link" href="#thinking-36" title="Direct link to heading">​</a></h3><p>思考上面这一段话，并根据自己在lab2 中的理解，回答：</p><ul><li>我们这里出现的” 指令位置” 的概念，你认为该概念是针对虚拟空间，还是物理内存所定义的呢？</li><li>你觉得entry_point其值对于每个进程是否一样？该如何理解这种统一或不同？</li></ul><p>答：</p><p>(1) 虚拟空间。当我们运行进程时，CPU 将自动从pc所指的位置开始执行二进制码，此时的空间是连续的，而虚拟空间对应的物理内存可能是不连续的，因此是虚拟空间。</p><p>(2) 一样。每个进程都有独立的虚拟空间，因此entry_point其值对于每个进程一样，是程序入口；但entry_point实际映射的物理地址不同。</p><h3 class="anchor anchorWithStickyNavbar_31ik" id="thinking-37">Thinking 3.7<a aria-hidden="true" class="hash-link" href="#thinking-37" title="Direct link to heading">​</a></h3><p>思考一下，要保存的进程上下文中的env_tf.pc的值应该设置为多少？为什么要这样设置？</p><p>答：</p><p>要保存的进程上下文中的env_tf.pc的值应该设置为cp0_epc，从而从被中断的指令继续运行。</p><h3 class="anchor anchorWithStickyNavbar_31ik" id="thinking-38">Thinking 3.8<a aria-hidden="true" class="hash-link" href="#thinking-38" title="Direct link to heading">​</a></h3><p>思考TIMESTACK 的含义，并找出相关语句与证明来回答以下关于TIMESTACK 的问题：</p><ul><li>请给出一个你认为合适的TIMESTACK 的定义</li><li>请为你的定义在实验中找出合适的代码段作为证据(请对代码段进行分析)</li><li>思考TIMESTACK 和第18 行的KERNEL_SP 的含义有何不同</li></ul><p>答：</p><p>(1) TIMESTACK以下<code>[TIMESTACK - sizeof(struct Trapframe), TIMESTACK)</code>的空间存储着异常发生时的寄存器信息，是时钟中断的存储区。</p><p>(2) 在include/stackframe.h中可以找到：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly c"><pre tabindex="0" class="prism-code language-c codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">macro get_sp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mfc0    k1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> CP0_CAUSE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    andi    k1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x107C</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    xori    k1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x1000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bnez    k1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1f</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    li  sp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x82000000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    j   </span><span class="token number" style="color:#36acaa">2f</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bltz    sp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2f</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    lw  sp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> KERNEL_SP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">  nop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">endm</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>其中的0x82000000即TIMESTACK的值。本次实验产生的都是时钟中断（4号异常），进行的是<code>li	sp, 0x82000000</code>的操作，因此是时钟中断的存储区。</p><p>(3) TIMESTACK是时钟中断的存储区，而KERNEL_SP应当是系统调用的存储区。</p><h3 class="anchor anchorWithStickyNavbar_31ik" id="thinking-39">Thinking 3.9<a aria-hidden="true" class="hash-link" href="#thinking-39" title="Direct link to heading">​</a></h3><p>阅读 kclock_asm.S  文件并说出每行汇编代码的作用。</p><p>答：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly c"><pre tabindex="0" class="prism-code language-c codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">macro  setup_c0_status set clr </span><span class="token comment" style="color:#999988;font-style:italic">// 定义宏setup_c0_status，传入set置位和clr清零形参</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">set    push                </span><span class="token comment" style="color:#999988;font-style:italic">// 保存现场</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mfc0    t0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> CP0_STATUS      </span><span class="token comment" style="color:#999988;font-style:italic">// 读CP0_STATUS的值到t0寄存器      </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    or  t0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> \set</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">\clr           </span><span class="token comment" style="color:#999988;font-style:italic">// t0=(t0|set|clr)，将set为1的置1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    xor t0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> \clr                </span><span class="token comment" style="color:#999988;font-style:italic">// t0= xor(t0,clr)，将clr为1的置0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mtc0    t0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> CP0_STATUS      </span><span class="token comment" style="color:#999988;font-style:italic">// 将t0寄存器写回CP0_STATUS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">set    pop                 </span><span class="token comment" style="color:#999988;font-style:italic">// 恢复现场</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">endm                           </span><span class="token comment" style="color:#999988;font-style:italic">// 结束宏语句            </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">text                       </span><span class="token comment" style="color:#999988;font-style:italic">// 代码段</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">LEAF</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">set_timer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">                 </span><span class="token comment" style="color:#999988;font-style:italic">// LEAF定义不调用其他函数的叶子函数set_timer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    li t0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x01</span><span class="token plain">                 </span><span class="token comment" style="color:#999988;font-style:italic">// t0设为1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sb t0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xb5000100</span><span class="token plain">           </span><span class="token comment" style="color:#999988;font-style:italic">// 设置实时钟中断的频率为1秒1次</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sw  sp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> KERNEL_SP           </span><span class="token comment" style="color:#999988;font-style:italic">// 保存堆栈现场到KERNEL_SP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">setup_c0_status STATUS_CU0</span><span class="token operator" style="color:#393A34">|</span><span class="token number" style="color:#36acaa">0x1001</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 设置CP0_STATUS，set为0x10001001</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jr ra                       </span><span class="token comment" style="color:#999988;font-style:italic">// 函数返回</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nop                         </span><span class="token comment" style="color:#999988;font-style:italic">// 延迟槽</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">END</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">set_timer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">                  </span><span class="token comment" style="color:#999988;font-style:italic">// 结束函数</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_31ik" id="thinking-310">Thinking 3.10<a aria-hidden="true" class="hash-link" href="#thinking-310" title="Direct link to heading">​</a></h3><p>阅读相关代码，思考操作系统是怎么根据时钟周期切换进程的。</p><p>答：</p><ol><li>首先在set_timer设置实时钟中断的频率，实验中为1秒1次。</li><li>一旦实时钟中断产生，就会触发MIPS 4号中断，从而MIPS 将PC 指向0x80000080，从而跳转到.text.exc_vec3代码段执行。</li><li>通过text.exc<em>vec3代码段的分发，调用handle</em> int 函数来处理实时钟中断。</li><li>在handle<em> int 判断CP0_CAUSE寄存器是不是对应的4 号中断位引发的中断，如果是，则执行中断服务函数timer</em> irq。</li><li>在timer<em> irq里跳转到sched</em> yield，如果当前进程的时间片用完了，则切换到下一个进程。</li></ol><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>这是一篇从Hexo迁移的文章，创建于2020-04-24 18:43:36</p></div></div></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/BUAA/操作系统实验/操作系统-OS-Lab3-学习笔记"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« <!-- -->操作系统 OS Lab3 学习笔记</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/BUAA/操作系统实验/操作系统-OS-Lab4-extra-学习笔记"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">操作系统 OS Lab4-extra 学习笔记<!-- --> »</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#一实验思考题" class="table-of-contents__link toc-highlight">一、实验思考题</a><ul><li><a href="#thinking-31" class="table-of-contents__link toc-highlight">Thinking 3.1</a></li><li><a href="#thinking-32" class="table-of-contents__link toc-highlight">Thinking 3.2</a></li><li><a href="#thinking-33" class="table-of-contents__link toc-highlight">Thinking 3.3</a></li><li><a href="#thinking-34" class="table-of-contents__link toc-highlight">Thinking 3.4</a></li><li><a href="#thinking-35" class="table-of-contents__link toc-highlight">Thinking 3.5</a></li><li><a href="#thinking-36" class="table-of-contents__link toc-highlight">Thinking 3.6</a></li><li><a href="#thinking-37" class="table-of-contents__link toc-highlight">Thinking 3.7</a></li><li><a href="#thinking-38" class="table-of-contents__link toc-highlight">Thinking 3.8</a></li><li><a href="#thinking-39" class="table-of-contents__link toc-highlight">Thinking 3.9</a></li><li><a href="#thinking-310" class="table-of-contents__link toc-highlight">Thinking 3.10</a></li></ul></li></ul></div></div></div></div></main></div></div></div>
<script src="/assets/js/runtime~main.f755d14c.js"></script>
<script src="/assets/js/main.2253602e.js"></script>
</body>
</html>